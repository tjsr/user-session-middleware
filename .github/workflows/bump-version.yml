name: "Update version number and publish to package repository."
run-name: "${{ inputs.noTag != 'true' && 'Bump/tag' || 'Bump' }} version (${{ inputs.patchlevel }}) ${{ inputs.noPublish == 'true' && 'on' || 'and publish'}} ${{ github.repository}}"
on:
  workflow_dispatch:
    inputs:
      patchlevel:
        type: choice
        description: 'Patch level'
        required: true
        default: 'prerelease'
        options:
        - 'prerelease'
        - 'patch'
        - 'minor'
        - 'major'
      noTag:
        description: 'Do not create a tag'
        default: false
        type: boolean
      noPublish:
        description: 'Do not publish'
        default: false
        type: boolean
  
permissions:
  contents: write
  packages: write

jobs:
  bump:
    name: "Bump version number and publish"
    env:
      NODE_CACHE_KEY: "npm-cache-${{ github.run_id }}-${{ github.run_number }}"
      NODE_VERSION: ${{ vars.NODE_VERSION }}
      NPM_VERSION: ${{ vars.NPM_VERSION }}
      NODE_AUTH_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
    
    runs-on: ubuntu-latest
    steps:
      - name: Verify inputs
        run: |
          if [ -z "${{ inputs.patchlevel }}" ]; then
            echo "Patch level is required."
            exit 1
          fi

      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Common node/npm setup
        id: node-setup
        uses: tjsr/gh-util-actions/node-common-setup@main
        with:
          # token: ${{ secrets.PACKAGE_PUBLISH_TOKEN }}
          token: ${{ secrets.GITHUB_TOKEN }}
          scope: "@tjsr"
          cache-key: ${{ env.NODE_CACHE_KEY}}
          node-version: ${{ env.NODE_VERSION }}
          npm-version: ${{ env.NPM_VERSION }}

      - name: Bump and publish
        id: bump
        uses: tjsr/gh-util-actions/version-bump-publish@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          scope: "@tjsr"
          patchlevel: ${{ inputs.patchlevel }}
          no-tag: ${{ inputs.noTag }}
          no-publish: ${{ inputs.noPublish }}
          cache-key: ${{ env.NODE_CACHE_KEY}}
          node-version: ${{ env.NODE_VERSION }}
          npm-version: ${{ env.NPM_VERSION }}
          preid: ${{ github.ref != 'refs/head/main' && 'dev' || 'release' }}

      - name: "Confirm published: ${{ steps.bump.outputs.version }}"
        if: ${{ steps.bump.conclusion == 'success' }}
        run: |
          if [ -z "${{ steps.bump.outputs.version }}" ]; then
            echo "No version published"
            exit 1
          fi
          echo "Published: ${{ steps.bump.outputs.version }}"
